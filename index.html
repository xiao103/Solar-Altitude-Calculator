<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤ªé˜³é«˜åº¦è§’ä¸é˜´å½±é•¿åº¦è®¡ç®—å™¨</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/svg2pdf.js/1.0.0/svg2pdf.min.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
    }
    ã€‚container {
      max-width: 960px;
      margin-top: 2rem;
      margin-bottom: 2rem;
    }
    ã€‚card {
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border-radius: 0.5rem;
    }
    ã€‚card-header {
      background-color: #0d6efd;
      color: white;
      font-weight: bold;
      border-top-left-radius: 0.5rem;
      border-top-right-radius: 0.5rem;
    }
    ã€‚form-label {
      font-weight: 500;
    }
    #shadowCanvas {
      background: #fff;
      border: 1px solid #ccc;
    }
    .export-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }
    .hemisphere-info {
      text-align: center;
      margin-top: 10px;
      font-weight: bold;
      color: #dc3545;
    }
    footer {
      margin-top: 2rem;
      text-align: center;
      color: #6c757d;
    }
    #svgContainer {
      display: none;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="card">
    <h5 class="card-header text-center py-3">â˜€ï¸ å¤ªé˜³é«˜åº¦è§’ä¸é˜´å½±é•¿åº¦è®¡ç®—å™¨</h5>
    <div class="card-body p-4">
      <div class="row g-3">
        <div class="col-md-6 col-lg-3">
          <label for="latitude" class="form-label">çº¬åº¦ (Â°)</label>
          <input type="number" class="form-control" id="latitude" value="25.03" step="0.01">
          <small class="form-text text-muted">æ­£æ•°ä¸ºåŒ—çº¬ï¼Œè´Ÿæ•°ä¸ºå—çº¬</small>
        </div>
        <div class="col-md-6 col-lg-3">
          <label for="longitude" class="form-label">ç»åº¦ (Â°)</label>
          <input type="number" class="form-control" id="longitude" value="121.56" step="0.01">
          <small class="form-text text-muted">æ­£æ•°ä¸ºä¸œç»ï¼Œè´Ÿæ•°ä¸ºè¥¿ç»</small>
        </div>
        <div class="col-md-6 col-lg-3">
          <label for="objectHeight" class="form-label">ç‰©ä½“é«˜åº¦ (mm)</label>
          <input type="number" class="form-control" id="objectHeight" value="20" min="0">
        </div>
        <div class="col-md-6 col-lg-3">
          <label for="date" class="form-label">æ—¥æœŸ</label>
          <input type="date" class="form-control" id="date">
        </div>
        <div class="col-12">
          <label for="timezone" class="form-label">æ—¶åŒº</label>
          <select class="form-select" id="timezone">
            <option value="-12">UTC-12:00 (å¤¸è´¾æ—ç¯ç¤)</option>
            <option value="-11">UTC-11:00 (ä¸­é€”å²›)</option>
            <option value="-10">UTC-10:00 (æª€é¦™å±±)</option>
            <option value="-9">UTC-09:00 (å®‰å…‹é›·å¥‡)</option>
            <option value="-8">UTC-08:00 (æ´›æ‰çŸ¶)</option>
            <option value="-7">UTC-07:00 (ä¸¹ä½›)</option>
            <option value="-6">UTC-06:00 (èŠåŠ å“¥)</option>
            <option value="-5">UTC-05:00 (çº½çº¦)</option>
            <option value="-4">UTC-04:00 (åœ£åœ°äºšå“¥)</option>
            <option value="-3">UTC-03:00 (é‡Œçº¦çƒ­å†…å¢)</option>
            <option value="-2">UTC-02:00 (åœ£ä¿ç½—)</option>
            <option value="-1">UTC-01:00 (äºšé€Ÿå°”ç¾¤å²›)</option>
            <option value="0">UTCÂ±00:00 (ä¼¦æ•¦)</option>
            <option value="1">UTC+01:00 (æŸæ—)</option>
            <option value="2">UTC+02:00 (å¼€ç½—)</option>
            <option value="3">UTC+03:00 (è«æ–¯ç§‘)</option>
            <option value="4">UTC+04:00 (è¿ªæ‹œ)</option>
            <option value="5">UTC+05:00 (å¡æ‹‰å¥‡)</option>
            <option value="6">UTC+06:00 (è¾¾å¡)</option>
            <option value="7">UTC+07:00 (æ›¼è°·)</option>
            <option value="8" selected>UTC+08:00 (åŒ—äº¬)</option>
            <option value="9">UTC+09:00 (ä¸œäº¬)</option>
            <option value="10">UTC+10:00 (æ‚‰å°¼)</option>
            <option value="11">UTC+11:00 (é©¬åŠ ä¸¹)</option>
            <option value="12">UTC+12:00 (å¥¥å…‹å…°)</option>
            <option value="13">UTC+13:00 (åŠªåº“é˜¿æ´›æ³•)</option>
            <option value="14">UTC+14:00 (åŸºé‡Œå·´æ–¯)</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <div class="card mt-4">
    <h5 class="card-header text-center py-3">ğŸ“Š è®¡ç®—ç»“æœ</h5>
    <div class="card-body">
      <table class="table table-striped table-hover text-center" id="resultsTable">
        <thead>
          <tr>
            <th scope="col">æ—¶é—´</th>
            <th scope="col">å¤ªé˜³é«˜åº¦è§’ (Â°)</th>
            <th scope="col">é˜´å½±é•¿åº¦ (mm)</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>
    </div>
  </div>

  <div class="card mt-4">
    <h5 class="card-header text-center py-3">ğŸ“ é˜´å½±æ–¹å‘å›¾ç¤º (ä»…20cmä»¥å†…)</h5>
    <div class="card-body text-center">
      <div id="hemisphereDisplay" class="hemisphere-info"></div>
      <canvas id="shadowCanvas" width="400" height="400"></canvas>
      <div class="export-buttons">
        <button id="exportSVG" class="btn btn-success">å¯¼å‡ºSVG</button>
      </div>
    </div>
  </div>
</div>
<footer>
  <p>&copy; 2025 ç”Ÿæœ¬æ•™å…·ï¼ˆæµ™æ±Ÿï¼‰æœ‰é™å…¬å¸</p>
</footer>

<!-- éšè—çš„SVGå®¹å™¨ç”¨äºå¯¼å‡º -->
<div id="svgContainer"></div>

<script>
const latitudeInput = document.getElementById('latitude');
const longitudeInput = document.getElementById('longitude');
const dateInput = document.getElementById('date');
const timezoneSelect = document.getElementById('timezone');
const objectHeightInput = document.getElementById('objectHeight');
const resultsBody = document.getElementById('resultsBody');
const canvas = document.getElementById('shadowCanvas');
const ctx = canvas.getContext('2d');
const exportSVG = document.getElementById('exportSVG');
const exportPDF = document.getElementById('exportPDF');
const svgContainer = document.getElementById('svgContainer');
const hemisphereDisplay = document.getElementById('hemisphereDisplay');

// å­˜å‚¨æœ€åè®¡ç®—çš„é˜´å½±æ•°æ®
let lastShadowData = [];
let currentHemisphere = '';

// åˆå§‹åŒ–æ—¥æœŸ
document.addEventListener('DOMContentLoaded', () => {
  const today = new Date();
  dateInput.value = today.toISOString().split('T')[0];
  [latitudeInput, longitudeInput, dateInput, timezoneSelect, objectHeightInput]
    .forEach(input => input.addEventListener('input', calculateAndDisplay));
  calculateAndDisplay();
  
  // æ·»åŠ å¯¼å‡ºäº‹ä»¶ç›‘å¬
  exportSVG.addEventListener('click', exportAsSVG);
  exportPDF.addEventListener('click', exportAsPDF);
});

function calculateAndDisplay() {
  const lat = parseFloat(latitudeInput.value);
  const lon = parseFloat(longitudeInput.value);
  const dateStr = dateInput.value;
  const tzOffset = parseFloat(timezoneSelect.value);
  const height = parseFloat(objectHeightInput.value);

  // ç¡®å®šå½“å‰åŠçƒ
  currentHemisphere = lat >= 0 ? 'åŒ—åŠçƒ' : 'å—åŠçƒ';
  hemisphereDisplay.textContent = `å½“å‰ä½ç½®: ${currentHemisphere} (${lat > 0 ? 'åŒ—çº¬' : 'å—çº¬'}${Math.abs(lat).toFixed(2)}Â°)`;
  
  if (isNaN(lat) || isNaN(lon) || isNaN(height) || height <= 0 || !dateStr) {
    resultsBody.innerHTML = '<tr><td colspan="3">è¯·è¾“å…¥æœ‰æ•ˆçš„ç»çº¬åº¦ã€æ—¥æœŸä¸ç‰©ä½“é«˜åº¦</td></tr>';
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    lastShadowData = [];
    return;
  }

  const [year, month, day] = dateStr.split('-').map(Number);
  resultsBody.innerHTML = '';
  lastShadowData = [];

  for (let hour = 0; hour < 24; hour++) {
    const utcTime = Date.UTC(year, month - 1, day, hour) - tzOffset * 3600 * 1000;
    const dateObj = new Date(utcTime);
    const sun = SunCalc.getPosition(dateObj, lat, lon);
    const alt = sun.altitude;
    const az = sun.azimuth;

    const altDeg = (alt * 180 / Math.PI).toFixed(2);
    let shadow = 'â€”';
    let shadowValue = null;

    if (alt > 0) {
      shadowValue = height / Math.tan(alt);
      shadow = shadowValue.toFixed(2);
    } else {
      shadow = 'æ— ç©·é•¿';
    }

    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${hour}:00</td><td>${altDeg}</td><td>${shadow}</td>`;
    resultsBody.appendChild(tr);

    if (shadowValue !== null && shadowValue <= 200) {
      lastShadowData.push({ hour, azimuth: az, length: shadowValue });
    }
  }

  drawShadowCanvas(lastShadowData, lat);
}

// ç»˜åˆ¶ä»¥åŒ—ä¸ºä¸Šï¼Œå½±å­ä»ä¸­å¿ƒå‘ azimuth æ–¹å‘å»¶ä¼¸çš„å›¾ç¤º
function drawShadowCanvas(data, latitude) {
  const width = canvas.width;
  const height = canvas.height;
  const cx = width / 2;
  const cy = height / 2;
  const scale = 1.5; // 1åƒç´  = 1.5mm

  ctx.clearRect(0, 0, width, height);

  // Draw circle & center point
  ctx.strokeStyle = '#999';
  ctx.beginPath();
  ctx.arc(cx, cy, 180, 0, Math.PI * 2);
  ctx.stroke();

  ctx.fillStyle = 'black';
  ctx.beginPath();
  ctx.arc(cx, cy, 3, 0, Math.PI * 2);
  ctx.fill();

  data.forEach(({ azimuth, length }) => {
    // ä¿®æ­£è§’åº¦ï¼Œè®©åŒ—æ–¹æœä¸Š
    const angle = azimuth + Math.PI / 2;
    const x = cx + length * scale * Math.cos(angle);
    const y = cy - length * scale * Math.sin(angle);

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(x, y);
    ctx.strokeStyle = 'red';
    ctx.lineWidth = 2;
    ctx.stroke();
  });
}

// ç”ŸæˆSVGå†…å®¹
function generateSVGContent(data, latitude) {
  const width = 400;
  const height = 400;
  const cx = width / 2;
  const cy = height / 2;
  const scale = 1.5;
  
  let svgContent = `
<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
  <rect width="100%" height="100%" fill="white"/>
  <circle cx="${cx}" cy="${cy}" r="180" stroke="#999" fill="none"/>
  <circle cx="${cx}" cy="${cy}" r="3" fill="black"/>
  <text x="${cx - 6}" y="${cy - 180 + 15}" font-family="sans-serif" font-size="14" fill="#333">åŒ—</text>
  `;
  
  // æ·»åŠ å—åŠçƒæ ‡è¯†
  if (latitude < 0) {
    svgContent += `
  <text x="${cx}" y="${cy + 180 - 15}" font-family="sans-serif" font-size="12" fill="#dc3545" text-anchor="middle">å—åŠçƒæ¨¡å¼</text>`;
  }
  
  // æ·»åŠ é˜´å½±çº¿
  data.forEach(({ azimuth, length }) => {
    let angle;
    
    // å—åŠçƒéœ€è¦åè½¬æ–¹ä½è§’
    if (latitude < 0) {
      angle = azimuth + Math.PI; // å—åŠçƒåè½¬æ–¹å‘
    } else {
      angle = azimuth + Math.PI; // åŒ—åŠçƒæ­£å¸¸è®¡ç®—
    }
    
    const x = cx + Math.sin(angle) * length / scale;
    const y = cy - Math.cos(angle) * length / scale;
    
    svgContent += `
  <line x1="${cx}" y1="${cy}" x2="${x}" y2="${y}" stroke="#0d6efd" stroke-width="1"/>`;
  });
  
  svgContent += `
</svg>`;
  
  return svgContent;
}

// å¯¼å‡ºä¸ºSVG
function exportAsSVG() {
  if (lastShadowData.length === 0) {
    alert('è¯·å…ˆè¿›è¡Œè®¡ç®—å¹¶ç”Ÿæˆé˜´å½±å›¾');
    return;
  }
  
  const lat = parseFloat(latitudeInput.value);
  const svgContent = generateSVGContent(lastShadowData, lat);
  const blob = new Blob([svgContent], {type: 'image/svg+xml'});
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = `å¤ªé˜³é˜´å½±å›¾_${currentHemisphere}.svg`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// å¯¼å‡ºä¸ºPDF
// ç§»é™¤å¯¼å‡ºPDFæŒ‰é’®ç›¸å…³ä»£ç 
// ç§»é™¤PDFå¯¼å‡ºç›¸å…³äº‹ä»¶ç›‘å¬
// exportPDF.removeEventListener('click', exportAsPDF);

// ç§»é™¤ exportAsPDF å‡½æ•°
// function exportAsPDF() {
//   const svgElement = document.querySelector('#svgContainer svg');
//   const pdf = new jsPDF('landscape');
//   const svgWidth = svgElement.width.baseVal.value;
//   const svgHeight = svgElement.height.baseVal.value;
//   const pdfWidth = pdf.internal.pageSize.getWidth();
//   const pdfHeight = pdf.internal.pageSize.getHeight();
//   const scale = Math.min(pdfWidth / svgWidth, pdfHeight / svgHeight);
// 
//   svg2pdf(svgElement, pdf, { xOffset: 0, yOffset: 0, scale: scale }).then(() => {
//     const hemisphereText = currentHemisphere === 'north' ? 'åŒ—åŠçƒ' : 'å—åŠçƒ';
//     pdf.save(`å¤ªé˜³é˜´å½±å›¾_${hemisphereText}.pdf`);
//   });
// }
</script>
</body>
</html>
